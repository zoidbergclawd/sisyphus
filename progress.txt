# Sisyphus Progress Log

## Session Start: 2026-02-15 08:45:22

---

## Item 1: Recursive Graph Schema & Engine ✅

**Route:** C (Complex)
**Time:** ~15 min

**Files created:**
- web-vi/ (Next.js 14 project scaffold with TypeScript, Tailwind, App Router)
- web-vi/vitest.config.ts
- web-vi/src/engine/schema.ts
- web-vi/src/engine/runner.ts
- web-vi/src/engine/engine.test.ts

**Files modified:**
- web-vi/package.json (added vitest, test/typecheck scripts)

**Decisions:**
- Used Vitest over Jest for native TypeScript/ESM support and speed
- Schema is recursive: Graph -> Node[] -> Node.childGraph? -> Graph (tree structure)
- WhileLoop uses shift registers (LabVIEW pattern) for data flow across iterations
- ShiftRegisterRead/Write nodes inside loop body connect to the loop's input tunnels
- LoopCondition node controls loop continuation (LabVIEW-style stop terminal)
- maxIterations safety valve prevents infinite loops
- Topological sort (Kahn's algorithm) determines execution order within a graph
- Engine is fully headless — no UI dependencies

**Verification:** ✓ 7 tests passing, TypeScript type checking clean
- Flat graph: Constant -> Indicator
- Add node: two Constants -> Add -> Indicator (3+7=10)
- While Loop: 10 iterations incrementing from 0, outputs 10
- Infinite loop safety: maxIterations=5 caps execution
- Nested loops: outer 3x, inner 4x = 12 total increments

---

## Item 2: React Flow Harness & Node Types ✅

**Route:** C (Complex)
**Time:** ~15 min

**Files created:**
- web-vi/src/test-setup.ts
- web-vi/src/components/nodes/NumericControlNode.tsx
- web-vi/src/components/nodes/NumericIndicatorNode.tsx
- web-vi/src/components/nodes/AddNode.tsx
- web-vi/src/components/nodes/SubtractNode.tsx
- web-vi/src/components/nodes/index.ts
- web-vi/src/components/nodes/nodes.test.tsx
- web-vi/src/components/DiagramEditor.tsx

**Files modified:**
- web-vi/package.json (added reactflow, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event, jsdom)
- web-vi/vitest.config.ts (added jsdom environment, tsx test pattern, setup file, esbuild jsx:automatic)
- web-vi/src/app/page.tsx (replaced boilerplate with DiagramEditor via dynamic import)
- web-vi/src/app/layout.tsx (updated metadata title/description)
- web-vi/src/engine/engine.test.ts (fixed unused imports for ESLint build compliance)

**Decisions:**
- Four custom node types matching engine schema: NumericControl (editable input + source handle), NumericIndicator (display + target handle), Add (+, two targets + one source), Subtract (−, two targets + one source)
- NODE_TYPES registry exported as a single object for React Flow's nodeTypes prop
- DiagramEditor uses dark canvas (gray-950) with industrial/utilitarian aesthetic inspired by LabVIEW
- Palette sidebar with drag-to-create: stores node type in dataTransfer, creates node at drop position
- Selection visual feedback via Tailwind ring-2 ring-blue-500 class on selected nodes
- Animated cyan wires (stroke: #22d3ee) for connections with snap-to-grid (16px)
- Dynamic import with ssr:false for React Flow (requires browser APIs)
- Used @testing-library/react with ReactFlowProvider wrapper for component tests
- Added esbuild jsx:automatic to vitest config for React JSX transform

**Verification:** ✓ 19 tests passing (7 engine + 12 node), TypeScript clean, Next.js build clean
- NumericControlNode: renders label + editable input, onChange callback, output handle, selection ring
- NumericIndicatorNode: renders label + value display, input handle, selection ring
- AddNode: renders + symbol, two input handles, one output handle
- SubtractNode: renders − symbol, two input handles, one output handle
- NODE_TYPES: exports all four custom types

---

## Item 3: The While Loop Container (Sub-Flow) ✅

**Route:** C (Complex)
**Time:** ~15 min

**Files created:**
- web-vi/src/components/nodes/WhileLoopNode.tsx
- web-vi/src/components/parentChildHelpers.ts
- web-vi/src/components/diagram.test.tsx

**Files modified:**
- web-vi/src/components/nodes/index.ts (added WhileLoop to NODE_TYPES registry)
- web-vi/src/components/nodes/nodes.test.tsx (added WhileLoopNode tests, updated registry test)
- web-vi/src/components/DiagramEditor.tsx (added WhileLoop to palette, drop-into-container logic, onNodeDragStop reparenting)

**Decisions:**
- Used React Flow's native `parentNode` property for parent-child relationships — children render relative to parent, move together
- WhileLoopNode is a resizable container using `NodeResizer` from reactflow (bundled in v11.5+)
- Container uses dark translucent background (rgba slate) with cyan accent for LabVIEW industrial aesthetic
- Input tunnel (target handle "init") and output tunnel (source handle "result") match engine schema
- `findContainingLoop()` does position-based hit-testing to detect when a node is inside a WhileLoop's bounds
- `reparentNode()` handles coordinate conversion between absolute (canvas) and relative (parent-local) positions
- `onNodeDragStop` handler detects when existing nodes are dragged into/out of While Loops and reparents them
- `onDrop` handler auto-parents new nodes dropped inside a While Loop from the palette
- Child nodes get `extent: "parent"` to prevent dragging outside the container
- WhileLoop nodes get explicit `style: { width, height }` for React Flow to know container bounds
- Minimum container size: 200x150 for hit-testing, default size: 320x220

**Verification:** ✓ 29 tests passing (7 engine + 16 node + 6 diagram), TypeScript clean, Next.js build clean
- WhileLoopNode: renders label, input/output tunnel handles, selection visual feedback, default size
- NODE_TYPES: exports all five custom types including WhileLoop
- findContainingLoop: detects inside/outside/self containment correctly
- reparentNode: adopts into parent (absolute→relative), removes from parent (relative→absolute), no-op on same parent

---

## Item 4: Wiring & Execution ✅

**Route:** C (Complex)
**Time:** ~15 min

**Files created:**
- web-vi/src/engine/graphConverter.ts
- web-vi/src/engine/graphConverter.test.ts
- web-vi/src/engine/useExecution.ts
- web-vi/src/engine/useExecution.test.ts

**Files modified:**
- web-vi/src/components/DiagramEditor.tsx (added Run button, execution integration via runDiagram)

**Decisions:**
- Graph converter bridges React Flow nodes/edges to engine's recursive Graph schema
- Tunneling convention uses handle IDs: "init-tunnel-in" (source inside loop body) and "result-tunnel-out" (target inside loop body) to distinguish internal vs external wiring
- WhileLoop tunnels automatically create ShiftRegisterRead/Write, iteration counter, LessThan + LoopCondition inside the engine child graph
- Loop iterations controlled by maxIterations in WhileLoop data — the converter auto-generates the iteration counter and condition plumbing
- Nested loops handled via recursion in buildChildGraph — each nested WhileLoop gets its own child graph with shift registers
- runDiagram() is a pure function (nodes, edges → indicator updates) — easy to test without React
- Run button in sidebar updates all NumericIndicator values after execution
- Handle IDs on React Flow nodes (value, a, b, result, init, result) already match engine terminal names from Items 1-3

**Verification:** ✓ 37 tests passing (7 engine + 16 node + 6 diagram + 5 converter + 3 execution), TypeScript clean, Next.js build clean
- Flat graph: NumericControl(3) + NumericControl(7) → Add → Indicator = 10
- Subtract: NumericControl(10) - NumericControl(4) → Indicator = 6
- Unconnected nodes: graceful handling, indicator exists but receives no input
- WhileLoop tunneling: init=0, maxIterations=5, Add(i,1) → Indicator = 5
- Nested loops: outer 3x, inner 2x = 6 total increments
- runDiagram: flat graph returns {ind: 10}, empty diagram returns {}, WhileLoop returns {ind: 5}
